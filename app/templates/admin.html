{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-dark"><i class="bi bi-shield-lock-fill"></i> Painel de Gest√£o</h2>

    {# 1. CONTROLE DE PERMISS√ÉO: BOT√ïES EXPORTAR AGORA COM FORMUL√ÅRIO #}
    <div class="d-flex gap-2">
        {% if is_editable %}
            {# NOVO FORMUL√ÅRIO PARA EXPORTA√á√ÉO EXCEL #}
            <form method="GET" action="{{ url_for('main.exportar_excel') }}" class="form-exportar p-0 m-0">
                <input type="hidden" name="status" value="{{ request.args.get('status', '') }}">
                <input type="hidden" name="unidade" value="{{ request.args.get('unidade', '') }}">
                <input type="hidden" name="regiao" value="{{ request.args.get('regiao', '') }}">
                
                <button type="submit" class="btn btn-success">
                    <i class="bi bi-file-earmark-excel-fill"></i> Exportar Excel
                </button>
            </form>
        {% endif %}
    </div>
</div>

{# --- Formul√°rio de Filtros --- #}
{# J√Å SER√Å INTERCEPTADO PELO LISTENER UNIVERSAL DO BASE.HTML #}
<form method="GET" class="card p-3 mb-4 shadow-sm">
    <div class="row g-2">
        <div class="col-md-3">
            <label class="small text-muted">Filtrar por Status</label>
            <select name="status" class="form-select form-select-sm">
                <option value="">Todos</option>
                <option value="PENDENTE" {{ 'selected' if request.args.get('status')=='PENDENTE' else '' }}>‚ö™Ô∏è Pendente</option>
                <option value="EM AN√ÅLISE" {{ 'selected' if request.args.get('status')=='EM AN√ÅLISE' else '' }}>üü° Em An√°lise</option>
                <option value="APROVADO" {{ 'selected' if request.args.get('status')=='APROVADO' else '' }}>üü¢ Aprovado</option>
                <option value="NEGADO" {{ 'selected' if request.args.get('status')=='NEGADO' else '' }}>üî¥ Negado</option>
            </select>
        </div>
        <div class="col-md-3">
            <label class="small text-muted color-light" >Pesquisar por Unidade</label>
            <input type="text" name="unidade" class="text-add form-control form-control-sm" placeholder="Nome da UVIS..." value="{{ request.args.get('unidade', '') }}">
        </div>
        <div class="col-md-3">
            <label class="small text-muted">Regi√£o</label>
            <input type="text" name="regiao" class="text-add form-control form-control-sm" placeholder="Leste, Oeste..." value="{{ request.args.get('regiao', '') }}">
        </div>
        <div class="col-md-3 d-flex align-items-end">
            <button class="btn btn-success btn-sm w-100" type="submit"><i class="bi bi-funnel"></i> Filtrar</button>
        </div>
    </div>
</form>

{# --- Tabela de Pedidos --- #}
<div class="card shadow-sm border-0">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th style="width: 25%">Unidade</th>
                    <th style="width: 40%">Dados da Opera√ß√£o</th>
                    {# AJUSTE DO HEADER PARA REFLETIR O TIPO DE USU√ÅRIO #}
                    <th style="width: 35%">{% if is_editable %}Decis√£o & Ajustes{% else %}Status Atual & Protocolo{% endif %}</th>
                </tr>
            </thead>
            <tbody>
                {% for p in pedidos %}
                <tr>
                    <td class="align-top pt-3">
                        <strong class="text-primary fs-6">{{ p.autor.nome_uvis }}</strong>
                        <br>
                        <span class="badge bg-secondary mb-2 mt-1">{{ p.autor.regiao }}</span>

                        
                        <div class="small text-muted border-top pt-2 mt-2">
                            <i class="bi bi-calendar"></i> 
                            {{ p.data_agendamento.strftime('%d/%m/%Y') }} √†s {{ p.hora_agendamento.strftime('%H:%M') }} 
                            <br><br>

                            <i class="bi bi-geo-alt"></i>
                            {{ p.logradouro }}, {{ p.numero or 'S/N' }}
                            {% if p.complemento %} <br><span class="fst-italic">({{ p.complemento }})</span> {% endif %}
                            <br>
                            {{ p.bairro }} - {{ p.cidade }}/{{ p.uf }}
                            <br>
                            CEP: {{ p.cep }}
                        </div>
                        {# NOVO: BOT√ïES DE ADMIN/DELETAR #}
                        {% if current_user.tipo_usuario == 'admin' %}
                        <div class="d-flex gap-1 mt-2">
                            <a href="{{ url_for('main.admin_editar_completo', id=p.id) }}" class="btn btn-sm btn-success">
                                <i class="bi bi-pencil-square"></i> Editar
                            </a>
                            <form class="form-deletar" action="{{ url_for('main.deletar_registro', id=p.id) }}" method="POST">
                                <button type="submit" class="btn btn-sm btn-danger">
                                    <i class="bi bi-trash"></i> Deletar
                                </button>
                            </form>
                        </div>
                        {% endif %}
                        {# FIM NOVO BOT√ïES DE ADMIN/DELETAR #}

                    </td>

                    <td class="align-top pt-3">
                        {# Dados da Opera√ß√£o - GPS #}
                        {% if p.latitude and p.longitude %}
                        <div class="d-flex justify-content-between align-items-center p-2 rounded mb-3 border">
                            <div style="line-height: 1.2;">
                                <small class="text-muted d-block">GPS:</small>
                                <small class="fw-bold font-monospace">{{ p.latitude }}, {{ p.longitude }}</small>
                            </div>
                            <a href="http://maps.google.com/maps?q={{ p.latitude }},{{ p.longitude }}" target="_blank" class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-map-fill"></i> Mapa
                            </a>
                        </div>
                        {% else %}
                        <div class="alert alert-warning py-1 px-2 small mb-3">
                            <i class="bi bi-exclamation-triangle"></i> Sem coordenadas
                        </div>
                        {% endif %}

                        {# Dados da Opera√ß√£o - Detalhes #}
                        <div class="row g-2 small mb-2">
                            <div class="col-6">
                                <span class="text-muted d-block">Tipo de Visita:</span>
                                <strong class="text-capitalize">{{ p.tipo_visita or '--' }}</strong>
                            </div>
                            <div class="col-6">
                                <span class="text-muted d-block">Altura Voo:</span>
                                <strong>{{ p.altura_voo or '--' }}</strong>
                            </div>
                            <div class="col-12">
                                <span class="text-muted d-block">Foco:</span>
                                <strong>{{ p.foco }}</strong>
                            </div>
                        </div>

                        <div class="mb-3">
                            {% if p.criadouro %}
                            <span class="badge bg-danger">Criadouro: SIM</span>
                            {% else %}
                            <span class="badge bg-light text-secondary border">Criadouro: N√ÉO</span>
                            {% endif %}

                            {% if p.apoio_cet %}
                            <span class="badge bg-warning text-dark">Apoio CET: SIM</span>
                            {% else %}
                            <span class="badge bg-light text-secondary border">Apoio CET: N√ÉO</span>
                            {% endif %}
                        </div>

                        {% if p.observacao %}
                        <div class="p-2 border rounded small fst-italic text-muted campo-observacao"> 
                            <i class="bi bi-chat-quote me-1"></i> "{{ p.observacao }}"
                        </div>
                        {% endif %}
                    </td>

                    <td class="align-top pt-3 bg-opacity-50">
                        
                        {# FORMUL√ÅRIO DE ATUALIZA√á√ÉO (Ser√° pego pelo listener universal do BASE.HTML) #}
                        {% if is_editable %}
                        <form action="{{ url_for('main.atualizar', id=p.id) }}" method="POST">
                            <div class="row g-1 mb-2">
                                <div class="col-12"><label class="small fw-bold text-muted">Ajuste GPS (Lat / Long)</label></div>
                                <div class="col-6">
                                    <input name="latitude" class="form-control form-control-sm font-monospace" placeholder="Lat" value="{{ p.latitude or '' }}">
                                </div>
                                <div class="col-6">
                                    <input name="longitude" class="form-control form-control-sm font-monospace" placeholder="Long" value="{{ p.longitude or '' }}">
                                </div>
                            </div>

                            <label class="small fw-bold text-muted">Protocolo DECEA</label>
                            <input name="protocolo" class="form-control form-control-sm font-monospace mb-2" placeholder="BR-2025-XXXX" value="{{ p.protocolo or '' }}">

                            <div class="p-2 border rounded">
                                <label class="small fw-bold text-muted">Status</label>
                                <select name="status" class="form-select form-select-sm mb-2">
                                    <option value="PENDENTE" {% if p.status=='PENDENTE' %}selected{% endif %}>‚ö™Ô∏è Pendente</option>
                                    <option value="EM AN√ÅLISE" {% if p.status=='EM AN√ÅLISE' %}selected{% endif %}>üü° Em An√°lise</option>
                                    <option value="APROVADO" {% if p.status=='APROVADO' %}selected{% endif %}>üü¢ APROVAR</option>
                                    <option value="NEGADO" {% if p.status=='NEGADO' %}selected{% endif %}>üî¥ NEGAR</option>
                                </select>

                                <label class="small fw-bold text-muted">Justificativa (se negar)</label>
                                <input name="justificativa" class="form-control form-control-sm mb-2" value="{{ p.justificativa or '' }}">

                                {# ‚úÖ ADICIONADO type="submit" #}
                                <button class="btn btn-primary btn-sm w-100 fw-bold" type="submit">
                                    <i class="bi bi-check-lg"></i> Salvar Decis√£o
                                </button>
                            </div>
                        </form>
                        
                        {# CONTE√öDO SOMENTE LEITURA PARA 'VISUALIZAR' #}
                        {% else %}
                        
                        <div class="p-3 border rounded bg-white">
                            <label class="small fw-bold text-muted">Status Atual:</label>
                            <div class="text-center mb-3">
                                <span class="badge 
                                    {% if p.status=='PENDENTE' %}bg-secondary{% elif p.status=='EM AN√ÅLISE' %}bg-warning text-dark{% elif p.status=='APROVADO' %}bg-success{% elif p.status=='NEGADO' %}bg-danger{% endif %} 
                                    fs-6 p-2">
                                    {{ p.status }}
                                </span>
                            </div>

                            <label class="small fw-bold text-muted">Protocolo DECEA:</label>
                            <div class="mb-2 p-1 border rounded font-monospace small">
                                {{ p.protocolo or 'N/A' }}
                            </div>

                            <label class="small fw-bold text-muted">Justificativa (se houver):</label>
                            <div class="small p-1 border rounded fst-italic text-muted">
                                {{ p.justificativa or 'Nenhuma' }}
                            </div>
                        </div>
                        
                        {% endif %}
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="3" class="text-center py-5 text-muted">
                        <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                        Nenhum pedido encontrado.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {# --- Pagina√ß√£o --- #}
        {% if paginacao.pages > 1 %}
        <nav aria-label="Navega√ß√£o" class="mt-4 pb-3">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.admin_dashboard', page=paginacao.prev_num, status=request.args.get('status'), unidade=request.args.get('unidade'), regiao=request.args.get('regiao')) }}">Anterior</a>
                </li>
                <li class="page-item disabled"><a class="page-link">P√°gina {{ paginacao.page }} de {{ paginacao.pages }}</a></li>
                <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{{ url_for('main.admin_dashboard', page=paginacao.next_num, status=request.args.get('status'), unidade=request.args.get('unidade'), regiao=request.args.get('regiao')) }}">Pr√≥xima</a>
                </li>
            </ul>
        </nav>
        {% endif %}
    </div>
</div>


{% block scripts %}
<script>
// ESTE C√ìDIGO S√ì √â EXECUTADO NESTA P√ÅGINA E TEM PRIORIDADE SOBRE O LISTENER UNIVERSAL.

// ===================================
// 1. L√≥gica de Loading para Exporta√ß√£o
// ===================================

document.querySelectorAll('.form-exportar').forEach(form => {
    form.addEventListener('submit', function(e) {
        const submitButton = this.querySelector('button[type="submit"]');

        if (submitButton) {
            const clickedButton = submitButton;
            
            // O loading j√° foi aplicado pelo base.html (listener universal)
            
            // FOR√áA A REVERS√ÉO do loading ap√≥s 4 segundos
            setTimeout(() => {
                // Verifica se a fun√ß√£o global est√° dispon√≠vel antes de chamar
                if (typeof hideLoadingState === 'function') {
                    hideLoadingState(clickedButton);
                }
            }, 4000); // 4 segundos

            // O formul√°rio submete e inicia o download.
        }
    });
});

// ===================================
// 2. L√≥gica Customizada para DELE√á√ÉO
// ===================================
document.querySelectorAll('.form-deletar').forEach(form => {
    form.addEventListener('submit', function(e) {
        e.preventDefault();

        // Checagem do Dark Mode (do base.html)
        const isDarkMode = document.body.classList.contains('dark-mode');
        // Pega o bot√£o de submit para aplicar o loading depois
        const submitButton = form.querySelector('button[type="submit"]'); 

        Swal.fire({
            title: 'Tem certeza?',
            text: "Voc√™ est√° prestes a DELETAR PERMANENTEMENTE este registro.",
            icon: 'warning',
            
            // Aplica√ß√£o da classe Dark Mode no modal
            customClass: {
                popup: isDarkMode ? 'swal2-dark-mode' : '',
            },
            
            showCancelButton: true,
            confirmButtonColor: '#d33', 
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sim, deletar!',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                // ‚úÖ ATIVA√á√ÉO DO LOADING: Chama a fun√ß√£o antes de enviar
                if (typeof showLoadingState === 'function') {
                    showLoadingState(submitButton); 
                }
                
                form.submit();
            }
        });
    });
});
</script>
{% endblock %}


{% endblock %}