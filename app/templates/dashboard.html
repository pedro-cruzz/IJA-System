{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-secondary">
        <i class="bi bi-list-task"></i> Minhas Solicita√ß√µes
    </h2>
    <a href="{{ url_for('main.novo') }}" class="btn btn-success shadow-sm">
        <i class="bi bi-plus-lg"></i> Nova Solicita√ß√£o
    </a>
</div>

<form method="GET" class="card p-3 mb-4 shadow-sm border-0">
    <div class="row g-2 align-items-end">
        <div class="col-md-5">
            <label class="small text-muted mb-1">Filtrar por status</label>
            <select name="status" class="form-select form-select-sm">
                <option value="">Todos os Pedidos</option>
                <option value="PENDENTE" {{ 'selected' if request.args.get('status')=='PENDENTE' else '' }}>‚ö™Ô∏è Pendentes</option>
                <option value="EM AN√ÅLISE" {{ 'selected' if request.args.get('status')=='EM AN√ÅLISE' else '' }}>üü° Em An√°lise</option>
                <option value="APROVADO" {{ 'selected' if request.args.get('status')=='APROVADO' else '' }}>üü¢ Aprovados</option>
                <option value="APROVADO COM RECOMENDA√á√ïES" {{ 'selected' if request.args.get('status')=='APROVADO COM RECOMENDA√á√ïES' else ''}}>üü† Aprovado com Recomenda√ß√µes</option>
                <option value="NEGADO" {{ 'selected' if request.args.get('status')=='NEGADO' else '' }}>üî¥ Negados</option>
            </select>
        </div>

        <div class="col-md-3">
            <button type="submit" class="btn btn-success btn-sm w-100">
                <i class="bi bi-funnel me-2"></i> Filtrar
            </button>
        </div>

        {% if request.args.get('status') %}
        <div class="col-md-2">
            <a href="{{ url_for('main.dashboard') }}" class="btn btn-outline-secondary btn-sm w-100">
                <i class="bi bi-x-lg"></i> Limpar
            </a>
        </div>
        {% endif %}
    </div>
</form>

<div class="card shadow-sm border-0">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Data</th>
                        <th style="width: 40%">Localiza√ß√£o / Foco</th>
                        <th class="text-center">Situa√ß√£o</th>
                        <th class="text-center">A√ß√µes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in solicitacoes %}
                    <tr>
                        <td>
                            <strong class="text-main">
                                {{ p.data_agendamento.strftime('%d/%m/%y') }}
                            </strong>
                            <br />
                            <small class="text-muted">{{ p.hora_agendamento.strftime('%H:%M') }}</small>
                        </td>

                        <td>
                            <div class="d-flex flex-column">
                                <span class="fw-bold text-main">
                                    {{ p.logradouro }}, {{ p.numero or 'S/N' }}
                                    {% if p.complemento %} <span class="fw-normal text-muted">({{ p.complemento }})</span> {% endif %}
                                </span>
                                <small class="text-muted">
                                    {{ p.bairro }} - {{ p.cidade }}/{{ p.uf }}
                                </small>

                                <div class="mt-1">
                                    <span class="badge bg-secondary">{{ p.foco }}</span>
                                    {% if p.latitude %}
                                        <i class="bi bi-geo-alt-fill text-danger ms-1" title="Localiza√ß√£o GPS salva"></i>
                                    {% endif %}
                                </div>
                            </div>
                        </td>

                        <td class="text-center">
                            {% if p.status == 'PENDENTE' %}
                                <span class="badge bg-secondary text-white">Pendente</span>
                            {% elif p.status == 'APROVADO' %}
                                <span class="badge bg-success rounded-pill">Aprovado</span>
                                <div class="small text-success mt-1 fw-bold font-monospace">{{ p.protocolo }}</div>
                            {% elif p.status == 'APROVADO COM RECOMENDA√á√ïES' %}
                                <span class="badge bg-recomended text-dark rounded-pill"></i> Aprovado com Recomenda√ß√µes</span>
                                <div class="small text-warning mt-1 fw-bold font-monospace">{{ p.protocolo }}</div>
                            {% elif p.status == 'NEGADO' %}
                                <span class="badge bg-danger rounded-pill"></i> Negado</span>
                            {% else %}
                                <span class="badge bg-warning text-dark rounded-pill">Em An√°lise</span>
                            {% endif %}
                        </td>

                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalDetalhes{{ p.id }}">
                                <i class="bi bi-eye"></i> Detalhes
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4" class="text-center py-5 text-muted">
                            <i class="bi bi-inbox fs-1 d-block mb-3"></i>
                            <p>Nenhuma solicita√ß√£o encontrada.</p>
                            <a href="{{ url_for('main.novo') }}" class="btn btn-sm btn-primary">Criar Agora</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if paginacao and paginacao.pages > 1 %}
<nav aria-label="Navega√ß√£o de p√°ginas" class="mt-4">
    <ul class="pagination justify-content-center">
        <li class="page-item {% if not paginacao.has_prev %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('main.dashboard', page=paginacao.prev_num, status=request.args.get('status', '')) }}">Anterior</a>
        </li>
        {% for pg in paginacao.iter_pages() %}
            {% if pg %}
                {% if pg == paginacao.page %}
                <li class="page-item active"><a class="page-link">{{ pg }}</a></li>
                {% else %}
                <li class="page-item"><a class="page-link" href="{{ url_for('main.dashboard', page=pg, status=request.args.get('status', '')) }}">{{ pg }}</a></li>
                {% endif %}
            {% else %}
                <li class="page-item disabled"><a class="page-link">...</a></li>
            {% endif %}
        {% endfor %}
        <li class="page-item {% if not paginacao.has_next %}disabled{% endif %}">
            <a class="page-link" href="{{ url_for('main.dashboard', page=paginacao.next_num, status=request.args.get('status', '')) }}">Pr√≥xima</a>
        </li>
    </ul>
</nav>
{% endif %}

{# =========================
   MODAIS (1 por solicita√ß√£o)
========================= #}
{% for p in solicitacoes %}
<div class="modal fade" id="modalDetalhes{{ p.id }}" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Detalhes do Pedido #{{ p.id }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">

        <h6 class="text-primary border-bottom pb-2 fw-bold">
          <i class="bi bi-geo-alt-fill"></i> Localiza√ß√£o
        </h6>

        <p class="rua mb-1 small">
          <strong>Endere√ßo:</strong>
          {{ p.logradouro }}, {{ p.numero }}
          {{ '(' ~ p.complemento ~ ')' if p.complemento else '' }}
        </p>

        <p class="mb-2 small">
          <strong>Bairro:</strong> {{ p.bairro }} - {{ p.cidade }}/{{ p.uf }}
        </p>

        {% if p.latitude and p.longitude %}
        <div class="d-flex justify-content-between align-items-center p-2 rounded border mb-3">
          <div>
            <small class="text-muted d-block">Coordenadas:</small>
            <strong class="font-monospace small">{{ p.latitude }}, {{ p.longitude }}</strong>
          </div>
          <a href="https://www.google.com/maps/search/?api=1&query={{ p.latitude }},{{ p.longitude }}"
             target="_blank"
             class="btn btn-sm btn-danger">
            <i class="bi bi-map"></i> Ver Mapa
          </a>
        </div>
        {% endif %}

        <h6 class="text-primary border-bottom pb-2 fw-bold mt-3">
          <i class="bi bi-paperclip"></i> Anexo
        </h6>

        {% if p.anexo_path %}
        <div class="d-flex justify-content-between align-items-center p-2 rounded border mb-3">
          <div>
            <small class="text-muted d-block">Arquivo:</small>
            <strong class="small">{{ p.anexo_nome or 'Anexo' }}</strong>
          </div>

          <a href="{{ url_for('main.baixar_anexo', id=p.id) }}"
             target="_blank"
             class="btn btn-sm btn-outline-primary">
            <i class="bi bi-download"></i> Abrir / Baixar
          </a>
        </div>
        {% else %}
        <div class="alert alert-secondary py-2 small mb-3">
          Nenhum anexo enviado.
        </div>
        {% endif %}

        <h6 class="text-primary border-bottom pb-2 fw-bold mt-3">
          <i class="bi bi-sliders"></i> Opera√ß√£o
        </h6>

        <div class="row g-2 mb-2">
          <div class="col-6">
            <small class="text-muted d-block">Tipo de Visita:</small>
            <strong class="text-capitalize">{{ p.tipo_visita or '--' }}</strong>
          </div>
          <div class="col-6">
            <small class="text-muted d-block">Altura:</small>
            <strong>{{ p.altura_voo or '--' }}</strong>
          </div>
        </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <small class="text-muted d-block">Apoio CET?</small>
                        {% if p.apoio_cet %}<span class="badge bg-warning text-dark">SIM</span>{% else %}<span class="badge bg-secondary">N√ÉO</span>{% endif %}
                    </div>
                </div>

        {% if p.observacao %}
        <div class="p-2 rounded border mb-3">
          <small class="text-muted d-block fw-bold">Observa√ß√£o do Usu√°rio:</small>
          <em class="small">"{{ p.observacao }}"</em>
        </div>
        {% endif %}

        {% if p.status == 'NEGADO' %}
        <div class="alert alert-danger mb-0">
          <strong class="d-block"><i class="bi bi-x-circle"></i> Pedido Negado</strong>
          <small>{{ p.justificativa }}</small>
        </div>
        {% elif p.status == 'APROVADO' %}
        <div class="alert alert-success mb-0">
          <strong class="d-block"><i class="bi bi-check-circle"></i> Pedido Aprovado</strong>
          <small>Protocolo: {{ p.protocolo }}</small>
        </div>
        {% endif %}

      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
      </div>

    </div>
  </div>
</div>
{% endfor %}

<!-- =========================
     Chatbot UVIS (FAQ inteligente)
========================= -->
<style>
  .uvis-chat-btn {
    position: fixed;
    right: 18px;
    bottom: 18px;
    z-index: 1080;
    border-radius: 999px;
    padding: 12px 14px;
    box-shadow: 0 10px 30px rgba(0,0,0,.18);
  }
  .uvis-chat-bubble {
    max-width: 85%;
    padding: 10px 12px;
    border-radius: 14px;
    font-size: .92rem;
    line-height: 1.35rem;
    white-space: pre-wrap;
  }
  .uvis-chat-bubble.user { margin-left: auto; }
  .uvis-chat-bubble.bot  { margin-right: auto; }
  .uvis-chat-messages {
    height: calc(100vh - 240px);
    overflow: auto;
    padding: 12px;
    background: rgba(0,0,0,.02);
    border-radius: 12px;
  }

  /* Dark Mode (body.dark-mode) */
  body.dark-mode #uvisChatbot.offcanvas {
    background: #152233;
    color: var(--color-text-main);
    border-left: 1px solid #233549;
  }
  body.dark-mode #uvisChatbot .offcanvas-header {
    background: #152233;
    border-bottom: 1px solid #233549;
  }
  body.dark-mode #uvisChatbot .offcanvas-title { color: #ffffff; }
  body.dark-mode #uvisChatbot .btn-close { filter: invert(1); }
  body.dark-mode #uvisChatbot .offcanvas-body { color: var(--color-text-main); }
  body.dark-mode #uvisChatbot .uvis-chat-messages { background: rgba(255, 255, 255, 0.04); }

  body.dark-mode #uvisChatbot .uvis-chat-bubble.bot {
    background: #1c2b3f !important;
    border: 1px solid #233549 !important;
    color: var(--color-text-main) !important;
  }
  body.dark-mode #uvisChatbot .uvis-chat-bubble.user {
    background: var(--color-primary) !important;
    color: #ffffff !important;
  }
  body.dark-mode #uvisChatbot .form-control {
    background: #1c2b3f !important;
    border: 1px solid #334155 !important;
    color: var(--color-text-main) !important;
  }
  body.dark-mode #uvisChatbot .form-control::placeholder { color: var(--color-text-muted) !important; }
  body.dark-mode #uvisChatbot .btn-outline-secondary {
    color: var(--color-text-muted) !important;
    border-color: #334155 !important;
  }
  body.dark-mode #uvisChatbot .btn-outline-secondary:hover {
    background: rgba(255, 255, 255, 0.06) !important;
    color: var(--color-text-main) !important;
  }
  body.dark-mode #uvisChatbot small.text-muted { color: var(--color-text-muted) !important; }
</style>

<button class="btn btn-primary uvis-chat-btn" type="button"
        data-bs-toggle="offcanvas" data-bs-target="#uvisChatbot" aria-controls="uvisChatbot"
        title="Ajuda UVIS">
  <i class="bi bi-chat-dots-fill"></i>
</button>

<div class="offcanvas offcanvas-end" tabindex="-1" id="uvisChatbot" aria-labelledby="uvisChatbotLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" id="uvisChatbotLabel">
      <i class="bi bi-robot me-2"></i> Ajuda UVIS
    </h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>

  <div class="offcanvas-body d-flex flex-column gap-2">
    <div class="d-flex flex-wrap gap-2">
      <button class="btn btn-sm btn-outline-secondary" data-q="O que significa Em An√°lise?">Status</button>
      <button class="btn btn-sm btn-outline-secondary" data-q="Quais campos s√£o obrigat√≥rios na Nova Solicita√ß√£o?">Campos</button>
      <button class="btn btn-sm btn-outline-secondary" data-q="O que fazer se o CEP n√£o encontrar?">CEP</button>
      <button class="btn btn-sm btn-outline-secondary" data-q="Qual o checklist antes de enviar?">Checklist</button>
      <button class="btn btn-sm btn-outline-secondary" data-q="Como funciona Notifica√ß√µes e Agenda?">Notifica√ß√µes</button>
    </div>

    <div id="uvisChatMessages" class="uvis-chat-messages"></div>

    <div class="input-group mt-auto">
      <input id="uvisChatInput" type="text" class="form-control" placeholder="Digite sua d√∫vida...">
      <button id="uvisChatSend" class="btn btn-success">
        <i class="bi bi-send-fill"></i>
      </button>
    </div>

    <small class="text-muted">
      Baseado no manual UVIS. Se n√£o achar a resposta, tente reformular com palavras como ‚Äústatus‚Äù, ‚ÄúCEP‚Äù, ‚Äúnova solicita√ß√£o‚Äù, ‚Äúchecklist‚Äù.
    </small>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
(function () {
  const msgs = document.getElementById("uvisChatMessages");
  const input = document.getElementById("uvisChatInput");
  const sendBtn = document.getElementById("uvisChatSend");
  const offcanvasEl = document.getElementById("uvisChatbot");

  if (!msgs || !input || !sendBtn || !offcanvasEl) return;

  function escapeHtml(str) {
    return String(str || "")
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function renderBotHtml(text) {
    let html = escapeHtml(text);
    html = html.replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>");
    html = html.replace(/\n/g, "<br>");
    return html;
  }

  function addMsg(text, who) {
    const row = document.createElement("div");
    row.className = "d-flex mb-2 " + (who === "user" ? "justify-content-end" : "justify-content-start");

    const bubble = document.createElement("div");
    bubble.className = "uvis-chat-bubble " + who + " " + (who === "user" ? "bg-primary text-white" : "bg-white border");

    if (who === "bot") bubble.innerHTML = renderBotHtml(text);
    else bubble.textContent = text;

    row.appendChild(bubble);
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function addTyping() {
    const row = document.createElement("div");
    row.className = "d-flex mb-2 justify-content-start";
    row.id = "uvisTyping";
    const bubble = document.createElement("div");
    bubble.className = "uvis-chat-bubble bot bg-white border";
    bubble.textContent = "Digitando...";
    row.appendChild(bubble);
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function removeTyping() {
    const el = document.getElementById("uvisTyping");
    if (el) el.remove();
  }

  async function ask(text) {
    const q = (text || "").trim();
    if (!q) return;

    addMsg(q, "user");
    input.value = "";
    addTyping();

    try {
      const res = await fetch("/api/uvis/chatbot", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({message: q})
      });

      const data = await res.json().catch(() => ({}));
      removeTyping();

      if (!res.ok && res.status === 401) {
        addMsg("Sess√£o expirada. Fa√ßa login novamente.", "bot");
        return;
      }

      addMsg(data.answer || "N√£o consegui responder agora. Tente novamente.", "bot");
    } catch (e) {
      removeTyping();
      addMsg("Erro ao conectar com o chatbot. Avise o suporte.", "bot");
    }
  }

  addMsg("Ol√°! Me diga sua d√∫vida sobre o sistema (status, nova solicita√ß√£o, CEP, checklist, notifica√ß√µes...).", "bot");

  sendBtn.addEventListener("click", () => ask(input.value));
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") ask(input.value);
  });

  document.querySelectorAll("[data-q]").forEach(btn => {
    btn.addEventListener("click", () => ask(btn.getAttribute("data-q")));
  });

  offcanvasEl.addEventListener("shown.bs.offcanvas", () => {
    setTimeout(() => input.focus(), 100);
  });
})();
</script>
{% endblock %}
